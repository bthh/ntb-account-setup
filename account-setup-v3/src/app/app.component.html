<div class="app">
  <p-toast #toast position="top-center" styleClass="header-toast"></p-toast>
  
  <!-- Parent Logo -->
  <div class="parent-logo">
    <h1>WHITE LABEL</h1>
  </div>

  <!-- Parent Sidebar -->
  <div class="parent-sidebar">
    <div class="parent-nav-item active">
      <i class="pi pi-th-large"></i>
      Dashboard
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-users"></i>
      Clients
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-briefcase"></i>
      Accounts
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-chart-line"></i>
      Portfolio
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-file-text"></i>
      Reports
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-cog"></i>
      Settings
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-question-circle"></i>
      Support
    </div>
    <div class="parent-nav-item">
      <i class="pi pi-book"></i>
      Resources
    </div>
  </div>

  <!-- Parent Header -->
  <div class="parent-header">
    <div class="search-container">
      <i class="pi pi-search search-icon"></i>
      <input 
        type="text" 
        class="search-input" 
        placeholder="Search clients..."
      />
    </div>
    <div class="profile-section">
      <span>Valued Advisor</span>
      <div class="profile-icon">
        <i class="pi pi-user"></i>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content-area">
    <!-- Enhanced Account Setup Header -->
    <div class="enterprise-header">
      <div class="enterprise-header-content">
        <div class="flex align-items-center gap-4">
          <p-button 
            icon="pi pi-arrow-left" 
            label="Back"
            (onClick)="goBack()"
            severity="secondary"
            styleClass="back-button">
          </p-button>
          <p-button 
            icon="pi pi-bars" 
            [text]="true"
            severity="secondary"
            (onClick)="showSidebar()"
            styleClass="lg:hidden">
          </p-button>
          <div class="header-title-section">
            <h1 class="enterprise-title">New Account Setup</h1>
            <div class="enterprise-subtitle">Smith Family Portfolio</div>
          </div>
          <p-badge value="Demo" severity="info" styleClass="demo-badge"></p-badge>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-section">
          <div class="progress-info">
            <span class="progress-text">Progress: {{getOverallProgress()}}% Complete</span>
            <div class="progress-bar-container">
              <div class="progress-bar" [style.width.%]="getOverallProgress()"></div>
            </div>
          </div>
        </div>

        <div class="header-actions">
          <p-button 
            label="Previous" 
            icon="pi pi-chevron-left"
            severity="secondary"
            (onClick)="handlePreviousSection()"
            [disabled]="!canGoPrevious()"
            styleClass="nav-button">
          </p-button>
          <p-button 
            label="Next" 
            icon="pi pi-chevron-right"
            iconPos="right"
            (onClick)="handleNextSection()"
            [disabled]="!canGoNext()"
            styleClass="nav-button nav-button-primary">
          </p-button>
          
          <p-button 
            label="Review Summary" 
            icon="pi pi-clipboard"
            severity="info"
            (onClick)="showReviewSummary()"
            styleClass="nav-button">
          </p-button>
          
          <div class="review-mode-section">
            <span class="review-label">Review Mode ({{isReviewMode ? 'ON' : 'OFF'}})</span>
            <p-inputSwitch
              [(ngModel)]="isReviewMode"
              styleClass="review-mode-toggle">
            </p-inputSwitch>
          </div>
        </div>
      </div>
    </div>

    <div class="flex" style="height: calc(100vh - 160px)">
      <!-- Desktop Sidebar -->
      <div 
        class="hidden lg:block sidebar-container" 
        [style.width.px]="sidebarWidth">
        <div class="household-title">
          Smith Household
        </div>
        <div class="p-2">
          <!-- Members -->
          <div class="mb-2">
            <div class="section-group-header">
              <i class="pi pi-users"></i>
              Members
            </div>
            <p-accordion 
              [multiple]="true" 
              [activeIndex]="expandedMemberTabs"
              (onTabChange)="onMemberTabChange($event)">
              <p-accordionTab 
                *ngFor="let member of memberData">
                <ng-template pTemplate="header">
                  <div class="flex align-items-center justify-content-between w-full">
                    <div class="flex align-items-center gap-2">
                      <i [class]="member.icon + ' entity-icon'"></i>
                      <div class="entity-header-info">
                        <div class="entity-name">{{member.name}}</div>
                        <div class="entity-role">{{member.role}}</div>
                      </div>
                    </div>
                    <i [class]="getCompletionIcon(isEntityComplete('members', member.id)) + ' text-' + getCompletionSeverity(isEntityComplete('members', member.id)) + ' completion-icon'"></i>
                  </div>
                </ng-template>
                <div
                  *ngFor="let section of member.sections"
                  [class]="'section-nav-item ' + (currentSection === section.id && currentMember === member.id ? 'active' : '')"
                  (click)="handleSectionChange(castToSection(section.id), member.id, '')">
                  <div class="section-nav-content">
                    <i [class]="section.icon + ' section-nav-icon'"></i>
                    <span class="section-nav-text">{{section.name}}</span>
                  </div>
                  <i [class]="getCompletionIcon(getSectionCompletion('members', member.id, section.id)) + ' text-' + getCompletionSeverity(getSectionCompletion('members', member.id, section.id)) + ' completion-icon'"></i>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>

          <!-- Account Types -->
          <div>
            <div class="section-group-header">
              <i class="pi pi-briefcase"></i>
              Accounts
            </div>
            <p-accordion 
              [multiple]="true" 
              [activeIndex]="expandedAccountTabs"
              (onTabChange)="onAccountTabChange($event)">
              <p-accordionTab 
                *ngFor="let account of accountData">
                <ng-template pTemplate="header">
                  <div class="flex align-items-center justify-content-between w-full">
                    <div class="flex align-items-center gap-2">
                      <i [class]="account.icon + ' entity-icon'"></i>
                      <div class="entity-header-info">
                        <div class="entity-name">{{account.name}}</div>
                        <div class="entity-role">{{account.owners}}</div>
                      </div>
                    </div>
                    <i [class]="getCompletionIcon(isEntityComplete('accounts', account.id)) + ' text-' + getCompletionSeverity(isEntityComplete('accounts', account.id)) + ' completion-icon'"></i>
                  </div>
                </ng-template>
                <div
                  *ngFor="let section of account.sections"
                  [class]="'section-nav-item ' + (currentSection === section.id && currentAccount === account.id ? 'active' : '')"
                  (click)="handleSectionChange(castToSection(section.id), '', account.id)">
                  <div class="section-nav-content">
                    <i [class]="section.icon + ' section-nav-icon'"></i>
                    <span class="section-nav-text">{{section.name}}</span>
                  </div>
                  <i [class]="getCompletionIcon(getSectionCompletion('accounts', account.id, section.id)) + ' text-' + getCompletionSeverity(getSectionCompletion('accounts', account.id, section.id)) + ' completion-icon'"></i>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>
        </div>
        
        <!-- Resize Handle -->
        <div 
          class="sidebar-resize-handle"
          (mousedown)="handleMouseDown()"
          [style]="{
            position: 'absolute',
            right: 0,
            top: 0,
            bottom: 0,
            width: '4px',
            cursor: 'col-resize',
            'background-color': isResizing ? '#3b82f6' : 'transparent',
            transition: 'background-color 0.2s ease'
          }">
        </div>
      </div>

      <!-- Mobile Sidebar -->
      <p-sidebar 
        [(visible)]="sidebarVisible" 
        styleClass="w-full sm:w-20rem">
        <div class="p-2">
          <!-- Household Members -->
          <div class="mb-2">
            <div class="section-group-header">
              <i class="pi pi-users"></i>
              Smith Household Members
            </div>
            <p-accordion 
              [multiple]="true" 
              [activeIndex]="expandedMemberTabs"
              (onTabChange)="onMemberTabChange($event)">
              <p-accordionTab 
                *ngFor="let member of memberData">
                <ng-template pTemplate="header">
                  <div class="flex align-items-center justify-content-between w-full">
                    <div class="flex align-items-center gap-2">
                      <i [class]="member.icon + ' entity-icon'"></i>
                      <div class="entity-header-info">
                        <div class="entity-name">{{member.name}}</div>
                        <div class="entity-role">{{member.role}}</div>
                      </div>
                    </div>
                    <i [class]="getCompletionIcon(isEntityComplete('members', member.id)) + ' text-' + getCompletionSeverity(isEntityComplete('members', member.id)) + ' completion-icon'"></i>
                  </div>
                </ng-template>
                <div
                  *ngFor="let section of member.sections"
                  [class]="'section-nav-item ' + (currentSection === section.id && currentMember === member.id ? 'active' : '')"
                  (click)="handleMobileSectionChange(castToSection(section.id), member.id, '')">
                  <div class="section-nav-content">
                    <i [class]="section.icon + ' section-nav-icon'"></i>
                    <span class="section-nav-text">{{section.name}}</span>
                  </div>
                  <i [class]="getCompletionIcon(getSectionCompletion('members', member.id, section.id)) + ' text-' + getCompletionSeverity(getSectionCompletion('members', member.id, section.id)) + ' completion-icon'"></i>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>

          <!-- Account Types -->
          <div>
            <div class="section-group-header">
              <i class="pi pi-briefcase"></i>
              Accounts
            </div>
            <p-accordion 
              [multiple]="true" 
              [activeIndex]="expandedAccountTabs"
              (onTabChange)="onAccountTabChange($event)">
              <p-accordionTab 
                *ngFor="let account of accountData">
                <ng-template pTemplate="header">
                  <div class="flex align-items-center justify-content-between w-full">
                    <div class="flex align-items-center gap-2">
                      <i [class]="account.icon + ' entity-icon'"></i>
                      <div class="entity-header-info">
                        <div class="entity-name">{{account.name}}</div>
                        <div class="entity-role">{{account.owners}}</div>
                      </div>
                    </div>
                    <i [class]="getCompletionIcon(isEntityComplete('accounts', account.id)) + ' text-' + getCompletionSeverity(isEntityComplete('accounts', account.id)) + ' completion-icon'"></i>
                  </div>
                </ng-template>
                <div
                  *ngFor="let section of account.sections"
                  [class]="'section-nav-item ' + (currentSection === section.id && currentAccount === account.id ? 'active' : '')"
                  (click)="handleMobileSectionChange(castToSection(section.id), '', account.id)">
                  <div class="section-nav-content">
                    <i [class]="section.icon + ' section-nav-icon'"></i>
                    <span class="section-nav-text">{{section.name}}</span>
                  </div>
                  <i [class]="getCompletionIcon(getSectionCompletion('accounts', account.id, section.id)) + ' text-' + getCompletionSeverity(getSectionCompletion('accounts', account.id, section.id)) + ' completion-icon'"></i>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>
        </div>
      </p-sidebar>

      <!-- Main Content -->
      <div class="flex-1 p-3">
        <p-card styleClass="h-full">
          
          <!-- Review Summary Mode -->
          <div *ngIf="showReviewSummaryMode">
            <div class="flex justify-content-between align-items-center mb-3">
              <h2 class="text-2xl font-semibold m-0">Review Summary</h2>
              <p-button 
                label="Back to Forms" 
                icon="pi pi-arrow-left"
                severity="secondary"
                (onClick)="hideReviewSummary()">
              </p-button>
            </div>
            
            <app-review-summary
              [formData]="formData"
              [completionStatus]="completionStatus"
              (editAccount)="onEditAccount($event)"
              (submitForESign)="onSubmitForESign($event)"
              (submitAllReady)="onSubmitAllReady($event)">
            </app-review-summary>
          </div>

          <!-- Regular Form Mode -->
          <app-account-form *ngIf="!showReviewSummaryMode"
            [section]="currentSection"
            [memberId]="currentMember"
            [accountId]="currentAccount"
            [isReviewMode]="isReviewMode"
            [formData]="formData"
            [completionStatus]="completionStatus"
            (formDataChange)="onFormDataChange($event)"
            (completionStatusChange)="onCompletionStatusChange($event)"
            (previous)="handlePreviousSection()"
            (next)="handleNextSection()"
            [canGoPrevious]="canGoPrevious()"
            [canGoNext]="canGoNext()">
          </app-account-form>
          
        </p-card>
      </div>
    </div>
  </div>
</div>